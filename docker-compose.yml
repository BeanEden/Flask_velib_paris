version: "3.8"

services:
  # CONFIG SERVER (configsvr)
  configsvr:
    image: mongo:6
    command: [ "mongod", "--configsvr", "--replSet", "rsConfig", "--port", "27019", "--bind_ip_all" ]
    ports:
      - "27019:27019"
    volumes:
      - configdb:/data/db
    networks:
      - mongo-cluster

  # SHARD 1 (rsShard1)
  shard1:
    image: mongo:6
    command: [ "mongod", "--shardsvr", "--replSet", "rsShard1", "--port", "27018", "--bind_ip_all" ]
    ports:
      - "27018:27018"
    volumes:
      - shard1db:/data/db
    networks:
      - mongo-cluster

  # SHARD 2 (rsShard2)
  shard2:
    image: mongo:6
    command: [ "mongod", "--shardsvr", "--replSet", "rsShard2", "--port", "27020", "--bind_ip_all" ]
    ports:
      - "27020:27020"
    volumes:
      - shard2db:/data/db
    networks:
      - mongo-cluster

  # MONGOS (router)
  mongos:
    image: mongo:6
    restart: on-failure
    depends_on:
      - configsvr
      - shard1
      - shard2
    # CORRECTION ICI : sleep 15 (au lieu de 5) pour laisser le temps au setup d'initier la config
    command: >
      bash -c "echo 'Waiting for config server...' && sleep 15 && mongos --configdb rsConfig/configsvr:27019 --bind_ip_all --port 27017"
    ports:
      - "27017:27017"
    networks:
      - mongo-cluster

  # INIT: configure replica sets + add shards + enable sharding
  mongo-setup:
    image: mongo:6
    depends_on:
      - configsvr
      - shard1
      - shard2
      # CORRECTION ICI : On retire "- mongos" pour qu'il puisse démarrer AVANT le routeur
    volumes:
      - ./mongo-init:/mongo-init:ro
    entrypoint: [ "/bin/sh", "/mongo-init/mongo-setup.sh" ]
    networks:
      - mongo-cluster

  # FLASK app
  flask:
    build: ./flask
    depends_on:
      - mongos
    environment:
      - MONGO_URI=mongodb://mongos:27017/velib
      - MONGO_URI_CLOUD=${MONGO_URI_CLOUD:-}
      - OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY:-}
    ports:
      - "5000:5000"
    volumes:
      - ./flask:/app
      - ./models:/models
    networks:
      - mongo-cluster

  # SCRAPER (insère des données de test)
  scraper:
    build: ./scraper
    depends_on:
      - mongos
    environment:
      - MONGO_URI=mongodb://mongos:27017/velib
      - OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY:-}
    volumes:
      - ./scraper:/app
    networks:
      - mongo-cluster

  # WEATHER SCRAPER
  weather-scraper:
    build: ./scraper
    command: [ "python", "weather_scraper.py" ]
    depends_on:
      - mongos
    environment:
      - MONGO_URI=mongodb://mongos:27017/velib
      - MONGO_URI_CLOUD=${MONGO_URI_CLOUD:-}
      - OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY:-}
    volumes:
      - ./scraper:/app
    networks:
      - mongo-cluster

  # TRAINER
  trainer:
    build: ./trainer
    depends_on:
      - mongos
    environment:
      - MONGO_URI=mongodb://mongos:27017/velib
    volumes:
      - ./models:/models
    networks:
      - mongo-cluster

volumes:
  configdb:
  shard1db:
  shard2db:


networks:
  mongo-cluster:
    driver: bridge
